<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PromptForge â€” Free AI Prompt Enhancer</title>
  <meta name="description" content="Transform rough prompts into structured, production-ready prompts using GPT. 100% free, no API key needed." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>" />
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0c0b0a;
      --bg-elevated: #15140f;
      --bg-card: #1a1914;
      --bg-input: #11100c;
      --border: #2a2820;
      --border-focus: #5c4a1e;
      --amber: #d4a024;
      --amber-dim: #a07818;
      --amber-glow: rgba(212, 160, 36, 0.12);
      --amber-bright: #f0c040;
      --text: #cdc5b4;
      --text-dim: #7a7468;
      --text-heading: #ede6d6;
      --text-bold: #e8dfd0;
      --code-bg: #12110d;
      --code-border: #2a2820;
      --code-text: #c9a84c;
    }

    body {
      min-height: 100vh;
      background: var(--bg);
      font-family: 'Outfit', sans-serif;
      color: var(--text);
      overflow-x: hidden;
    }

    /* Noise texture */
    body::before {
      content: "";
      position: fixed; inset: 0;
      background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 9999;
    }

    .ambient {
      position: fixed; top: -200px; left: 50%; transform: translateX(-50%);
      width: 800px; height: 500px;
      background: radial-gradient(ellipse, rgba(212,160,36,0.06) 0%, transparent 70%);
      pointer-events: none; z-index: 0;
    }

    .container {
      position: relative; z-index: 1;
      max-width: 760px; margin: 0 auto;
      padding: 2.5rem 1.5rem 4rem;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header { text-align: center; margin-bottom: 2.4rem; animation: fadeDown 0.6s ease; }
    @keyframes fadeDown { from { opacity:0; transform:translateY(-16px); } to { opacity:1; transform:translateY(0); } }

    .brand { display: inline-flex; align-items: center; gap: 0.55rem; margin-bottom: 0.6rem; }
    .brand-icon {
      width: 38px; height: 38px; border-radius: 10px;
      background: linear-gradient(135deg, #d4a024, #a07818);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.15rem;
      box-shadow: 0 0 24px rgba(212,160,36,0.2), inset 0 1px 0 rgba(255,255,255,0.12);
    }
    .brand h1 {
      font-family: 'Instrument Serif', serif;
      font-size: 2rem; font-weight: 400;
      color: var(--text-heading); letter-spacing: -0.02em;
    }
    .brand h1 span { color: var(--amber); }

    .tagline { color: var(--text-dim); font-size: 0.92rem; font-weight: 300; line-height: 1.5; max-width: 480px; margin: 0 auto; }
    .tagline strong { color: var(--amber-dim); font-weight: 500; }

    .free-badge {
      display: inline-flex; align-items: center; gap: 5px;
      margin-top: 0.7rem; padding: 4px 12px;
      background: var(--amber-glow); border: 1px solid rgba(212,160,36,0.2);
      border-radius: 20px; font-size: 0.72rem; font-weight: 600;
      color: var(--amber); text-transform: uppercase; letter-spacing: 0.1em;
    }

    /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 16px; padding: 1.3rem; margin-bottom: 1.2rem;
      animation: fadeUp 0.5s ease both;
    }
    @keyframes fadeUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.7rem; }
    .card-label { font-size: 0.72rem; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; }
    .char-count { font-size: 0.72rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }

    /* â”€â”€ Textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    textarea {
      width: 100%; background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 10px; padding: 1rem 1.1rem;
      color: var(--text); font-family: 'Outfit', sans-serif;
      font-size: 0.95rem; font-weight: 300; line-height: 1.7;
      resize: vertical; min-height: 130px; outline: none;
      transition: border-color 0.25s, box-shadow 0.25s;
    }
    textarea:focus { border-color: var(--border-focus); box-shadow: 0 0 0 3px var(--amber-glow); }
    textarea::placeholder { color: #4a4538; font-weight: 300; }

    /* â”€â”€ Input footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .input-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 0.8rem; }
    .shortcut { font-size: 0.73rem; color: var(--text-dim); display: flex; align-items: center; gap: 0.4rem; }
    .kbd {
      display: inline-block; background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 4px; padding: 1px 6px;
      font-family: 'JetBrains Mono', monospace; font-size: 0.68rem; color: var(--text-dim);
    }

    /* â”€â”€ Enhance Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .enhance-btn {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.65rem 1.6rem; border: none; border-radius: 10px;
      background: linear-gradient(135deg, #d4a024, #b8891c);
      color: #0c0b0a; font-family: 'Outfit', sans-serif;
      font-size: 0.88rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 12px rgba(212,160,36,0.2), inset 0 1px 0 rgba(255,255,255,0.15);
    }
    .enhance-btn:hover:not(:disabled) { box-shadow: 0 4px 20px rgba(212,160,36,0.35); transform: translateY(-1px); }
    .enhance-btn:active:not(:disabled) { transform: translateY(0); }
    .enhance-btn:disabled { background: linear-gradient(135deg, #3a3425, #2e2a1e); color: var(--text-dim); cursor: not-allowed; box-shadow: none; }
    .enhance-btn.no-input { opacity: 0.5; }

    .spinner {
      display: inline-block; width: 14px; height: 14px;
      border: 2px solid rgba(12,11,10,0.3); border-top-color: #0c0b0a;
      border-radius: 50%; animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Model Selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.7rem; gap: 0.5rem; }
    .model-row { display: flex; align-items: center; gap: 0.5rem; }
    .model-label { font-size: 0.72rem; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; }
    .model-select {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 8px; padding: 0.4rem 2rem 0.4rem 0.7rem;
      color: var(--text); font-family: 'Outfit', sans-serif; font-size: 0.82rem;
      outline: none; cursor: pointer; appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237a7468' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 8px center;
    }
    .model-select:focus { border-color: var(--border-focus); }
    .model-select option { background: var(--bg-card); color: var(--text); }

    .history-toggle {
      background: none; border: 1px solid var(--border); color: var(--text-dim);
      font-family: 'Outfit', sans-serif; font-size: 0.76rem; font-weight: 500;
      cursor: pointer; padding: 0.35rem 0.7rem; border-radius: 8px;
      transition: all 0.2s; white-space: nowrap;
    }
    .history-toggle:hover { color: var(--amber); border-color: var(--border-focus); background: var(--amber-glow); }

    /* â”€â”€ History Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .history-panel {
      display: none; background: var(--bg-elevated); border: 1px solid var(--border);
      border-radius: 14px; padding: 0.8rem; margin-bottom: 1.2rem;
      max-height: 260px; overflow-y: auto;
    }
    .history-panel.open { display: block; animation: fadeUp 0.3s ease; }
    .history-item {
      padding: 0.55rem 0.7rem; border-radius: 8px; cursor: pointer;
      transition: background 0.15s; margin-bottom: 0.25rem;
    }
    .history-item:hover { background: var(--amber-glow); }
    .history-item:last-child { margin-bottom: 0; }
    .hi-prompt { font-size: 0.82rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .hi-time { font-size: 0.68rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; margin-top: 2px; }
    .history-empty { font-size: 0.82rem; color: var(--text-dim); text-align: center; padding: 1rem; }
    .history-clear {
      display: block; margin: 0.5rem auto 0; background: none; border: none;
      color: var(--text-dim); font-size: 0.72rem; cursor: pointer; text-decoration: underline;
      font-family: 'Outfit', sans-serif;
    }
    .history-clear:hover { color: #e74c3c; }

    /* â”€â”€ Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .error-box {
      background: #1a1210; border: 1px solid #3a1a15; border-radius: 10px;
      padding: 0.8rem 1rem; color: #e74c3c; font-size: 0.88rem;
      margin-bottom: 1.2rem; display: none;
    }

    /* â”€â”€ Result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .result-card { animation: resultIn 0.45s ease both; }
    @keyframes resultIn { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }

    .copy-btns { display: flex; gap: 0.45rem; flex-wrap: wrap; }
    .copy-btn {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 7px; padding: 0.3rem 0.75rem; color: var(--text-dim);
      font-family: 'Outfit', sans-serif; font-size: 0.73rem; font-weight: 500;
      cursor: pointer; transition: all 0.2s;
    }
    .copy-btn:hover { border-color: var(--border-focus); color: var(--amber); }
    .copy-btn.copied { background: var(--amber-dim); color: #0c0b0a; border-color: var(--amber-dim); }

    /* â”€â”€ Markdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .md { font-size: 0.92rem; line-height: 1.7; }
    .md h2 { font-family: 'Instrument Serif', serif; font-size: 1.15rem; font-weight: 400; color: var(--amber); margin: 1.3rem 0 0.4rem; }
    .md h3 { font-size: 0.95rem; font-weight: 600; color: var(--amber); margin: 1.2rem 0 0.35rem; }
    .md p { margin: 0.25rem 0; color: var(--text); }
    .md ul, .md ol { margin: 0.35rem 0; padding-left: 1.4rem; }
    .md li { margin-bottom: 0.2rem; color: var(--text); }
    .md hr { border: none; border-top: 1px solid var(--border); margin: 1rem 0; }
    .md strong { color: var(--text-bold); font-weight: 600; }
    .md code {
      background: var(--code-bg); padding: 0.12rem 0.4rem; border-radius: 4px;
      font-size: 0.85em; color: var(--code-text); border: 1px solid var(--code-border);
      font-family: 'JetBrains Mono', monospace;
    }
    .md pre {
      background: var(--code-bg); border: 1px solid var(--code-border);
      border-radius: 9px; padding: 0.8rem 1rem; margin: 0.5rem 0;
      overflow-x: auto; font-size: 0.83rem; line-height: 1.6;
      color: var(--code-text); font-family: 'JetBrains Mono', monospace;
    }
    .md .spacer { height: 0.35rem; }

    .streaming-cursor::after {
      content: "â–Š"; animation: blink 0.7s step-end infinite;
      color: var(--amber); font-weight: 400;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-dim); font-size: 0.88rem; font-weight: 300; }
    .empty-icon { font-size: 2.2rem; margin-bottom: 0.6rem; opacity: 0.35; }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .footer {
      text-align: center; margin-top: 3rem; padding-top: 1.5rem;
      border-top: 1px solid var(--border);
      font-size: 0.73rem; color: var(--text-dim); font-weight: 300;
    }
    .footer a { color: var(--amber-dim); text-decoration: none; }
    .footer a:hover { text-decoration: underline; }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 540px) {
      .container { padding: 1.5rem 1rem 3rem; }
      .brand h1 { font-size: 1.6rem; }
      .input-footer { flex-direction: column; gap: 0.6rem; align-items: stretch; }
      .shortcut { justify-content: center; }
      .enhance-btn { width: 100%; justify-content: center; }
      .toolbar { flex-wrap: wrap; }
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>

<div class="ambient"></div>

<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="brand">
      <div class="brand-icon">âš¡</div>
      <h1>Prompt<span>Forge</span></h1>
    </div>
    <p class="tagline">
      Transform rough prompts into structured, production-ready prompts using GPT.
      <strong>100% free</strong> â€” powered by Puter.js.
    </p>
    <div class="free-badge">
      <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
      Free forever Â· No API key needed
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="model-row">
      <span class="model-label">Model</span>
      <select class="model-select" id="modelSelect">
        <option value="gpt-4o-mini" selected>GPT-4o Mini (fast)</option>
        <option value="gpt-4o">GPT-4o</option>
        <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
        <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
      </select>
    </div>
    <button class="history-toggle" id="historyToggle" onclick="toggleHistory()">ðŸ“‹ History</button>
  </div>

  <!-- History -->
  <div class="history-panel" id="historyPanel">
    <div id="historyList"></div>
  </div>

  <!-- Input -->
  <div class="card">
    <div class="card-header">
      <span class="card-label">Your Prompt</span>
      <span class="char-count" id="charCount">0 chars</span>
    </div>
    <textarea id="promptInput" placeholder="e.g. Write me a blog post about AI trends in 2025..." rows="5"></textarea>
    <div class="input-footer">
      <div class="shortcut">
        <span class="kbd">âŒ˜</span><span class="kbd">Enter</span> to enhance
      </div>
      <button class="enhance-btn no-input" id="enhanceBtn" onclick="enhance()" disabled>âš¡ Enhance</button>
    </div>
  </div>

  <div class="error-box" id="errorBox"></div>
  <div id="resultArea"></div>
  <div class="empty-state" id="emptyState">
    <div class="empty-icon">âš¡</div>
    Your enhanced prompt will appear here
  </div>

  <div class="footer">
    PromptForge Â· Powered by <a href="https://puter.com" target="_blank">Puter.js</a> Â· <a href="https://github.com/" target="_blank">GitHub</a>
  </div>
</div>

<script src="https://js.puter.com/v2/"></script>
<script>
// â”€â”€â”€ System Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SYSTEM_PROMPT = `You are a Prompt Engineering Expert. Your ONLY job is to REWRITE the user's input into a better prompt. You must NEVER answer, solve, or respond to the user's request. You must ONLY restructure it.

ABSOLUTE RULES:
1. NEVER answer the user's question or task
2. NEVER provide information, advice, recommendations, or solutions
3. NEVER add fictional details or make up context
4. ONLY output a rewritten, improved version of their prompt
5. Preserve the user's original intent exactly
6. Add structure: role, task, constraints, output format
7. Make it clear, specific, and unambiguous

YOUR OUTPUT MUST USE THIS EXACT FORMAT AND NOTHING ELSE:
---
### Enhanced Prompt
<the rewritten prompt goes here â€” this should be instructions TO an AI, not an answer>

### Assumptions Made
- <list any assumptions you made while rewriting>

### Clarifying Questions (if needed)
- <questions the user should consider to improve their prompt further>
---

EXAMPLE:
User input: "Tell me about dogs"
WRONG (do NOT do this): "Dogs are domesticated mammals..."
CORRECT: 
---
### Enhanced Prompt
You are a knowledgeable animal expert. Provide a comprehensive overview of dogs covering their history of domestication, major breed categories, typical behavioral traits, care requirements, and their role in human society. Structure the response with clear sections and keep it informative yet accessible for a general audience.

### Assumptions Made
- The user wants a broad overview rather than information about a specific breed
- The response should be suitable for a general audience

### Clarifying Questions (if needed)
- Are you interested in a specific breed or dogs in general?
- Is this for educational, personal, or professional purposes?
---

Remember: You are rewriting prompts, NOT answering them.`;

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let isStreaming = false;
let fullResult = "";
let puterReady = false;
let history = [];
try { history = JSON.parse(localStorage.getItem("pf_history") || "[]"); } catch(e) { history = []; }

const $ = (id) => document.getElementById(id);

// â”€â”€â”€ Wait for Puter.js to load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function waitForPuter(maxWait) {
  return new Promise((resolve, reject) => {
    if (typeof puter !== "undefined" && puter.ai) { resolve(); return; }
    const start = Date.now();
    const check = setInterval(() => {
      if (typeof puter !== "undefined" && puter.ai) {
        clearInterval(check);
        resolve();
      } else if (Date.now() - start > maxWait) {
        clearInterval(check);
        reject(new Error("Puter.js failed to load. Please refresh the page."));
      }
    }, 200);
  });
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("DOMContentLoaded", async () => {
  // Wait for Puter.js (up to 10 seconds)
  try {
    await waitForPuter(10000);
    puterReady = true;
    console.log("âœ… Puter.js loaded successfully");
  } catch (e) {
    console.warn("âš ï¸ Puter.js not loaded yet:", e.message);
    showError("Puter.js is still loading. Please wait a moment and try again, or refresh the page.");
  }

  $("promptInput").addEventListener("input", () => {
    const len = $("promptInput").value.length;
    $("charCount").textContent = len + " chars";
    const btn = $("enhanceBtn");
    if (len > 0 && !isStreaming) { btn.disabled = false; btn.classList.remove("no-input"); }
    else if (!isStreaming) { btn.disabled = true; btn.classList.add("no-input"); }
  });

  $("promptInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) { e.preventDefault(); enhance(); }
  });

  renderHistory();
});

// â”€â”€â”€ Enhance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function enhance() {
  const input = $("promptInput").value.trim();
  if (!input || isStreaming) return;

  // Check if Puter is ready
  if (!puterReady || typeof puter === "undefined" || !puter.ai) {
    try {
      await waitForPuter(5000);
      puterReady = true;
    } catch (e) {
      showError("Puter.js hasn't loaded yet. Please refresh the page and try again.");
      return;
    }
  }

  isStreaming = true;
  fullResult = "";
  hideError();
  $("emptyState").style.display = "none";
  setLoading(true);

  $("resultArea").innerHTML = `
    <div class="card result-card">
      <div class="card-header">
        <span class="card-label">Enhanced Result</span>
        <div class="copy-btns">
          <button class="copy-btn" id="copyPromptBtn" onclick="copyEnhanced()">Copy Prompt</button>
          <button class="copy-btn" id="copyAllBtn" onclick="copyAll()">Copy All</button>
        </div>
      </div>
      <div class="md streaming-cursor" id="resultContent"></div>
    </div>`;

  const model = $("modelSelect").value;

  try {
    const messages = [
      { role: "system", content: SYSTEM_PROMPT },
      { role: "user", content: `REWRITE THE FOLLOWING USER PROMPT INTO A BETTER, STRUCTURED PROMPT. DO NOT ANSWER IT. ONLY ENHANCE IT.\n\nUser's original prompt:\n"""${input}"""\n\nNow rewrite the above as an enhanced prompt using the exact format specified.` },
    ];

    const response = await puter.ai.chat(messages, {
      model: model,
      stream: true,
    });

    for await (const part of response) {
      if (part?.text) {
        fullResult += part.text;
        const el = $("resultContent");
        if (el) el.innerHTML = markdownToHTML(fullResult);
      }
    }

    const el = $("resultContent");
    if (el) el.classList.remove("streaming-cursor");
    saveToHistory(input, fullResult, model);

  } catch (err) {
    console.error("Enhance error:", err);
    const el = $("resultContent");
    if (el) el.classList.remove("streaming-cursor");
    if (!fullResult) {
      showError(err.message || "Something went wrong. Please try again.");
      $("resultArea").innerHTML = "";
      $("emptyState").style.display = "";
    }
  } finally {
    isStreaming = false;
    setLoading(false);
  }
}

// â”€â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(on) {
  const btn = $("enhanceBtn");
  if (on) { btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Enhancingâ€¦'; }
  else { btn.disabled = !$("promptInput").value.trim(); btn.innerHTML = "âš¡ Enhance"; if ($("promptInput").value.trim()) btn.classList.remove("no-input"); }
}
function showError(msg) { $("errorBox").textContent = msg; $("errorBox").style.display = "block"; }
function hideError() { $("errorBox").style.display = "none"; }

function extractEnhancedPrompt(text) {
  const m = text.match(/###\s*Enhanced Prompt\s*\n([\s\S]*?)(?=\n###\s|$)/);
  return m ? m[1].trim() : text;
}

function copyEnhanced() { copyToClip(extractEnhancedPrompt(fullResult), "copyPromptBtn"); }
function copyAll() { copyToClip(fullResult, "copyAllBtn"); }

function copyToClip(text, btnId) {
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    const orig = btn.textContent;
    btn.textContent = "âœ“ Copied!";
    btn.classList.add("copied");
    setTimeout(() => { btn.textContent = orig; btn.classList.remove("copied"); }, 2000);
  });
}

// â”€â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleHistory() { $("historyPanel").classList.toggle("open"); }

function saveToHistory(prompt, result, model) {
  history.unshift({ prompt: prompt.slice(0, 300), result, model, time: new Date().toISOString() });
  if (history.length > 20) history = history.slice(0, 20);
  try { localStorage.setItem("pf_history", JSON.stringify(history)); } catch(e) {}
  renderHistory();
}

function renderHistory() {
  const el = $("historyList");
  if (!history.length) { el.innerHTML = '<div class="history-empty">No history yet â€” your enhanced prompts will appear here.</div>'; return; }
  el.innerHTML = history.map((item, i) => {
    const d = new Date(item.time);
    const t = d.toLocaleString(undefined, { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
    return `<div class="history-item" onclick="loadHistory(${i})"><div class="hi-prompt">${esc(item.prompt)}</div><div class="hi-time">${t} Â· ${item.model}</div></div>`;
  }).join("") + '<button class="history-clear" onclick="clearHistory()">Clear history</button>';
}

function loadHistory(i) {
  const item = history[i];
  if (!item) return;
  $("promptInput").value = item.prompt;
  $("promptInput").dispatchEvent(new Event("input"));
  fullResult = item.result;
  $("emptyState").style.display = "none";
  $("resultArea").innerHTML = `
    <div class="card result-card">
      <div class="card-header">
        <span class="card-label">Enhanced Result</span>
        <div class="copy-btns">
          <button class="copy-btn" id="copyPromptBtn" onclick="copyEnhanced()">Copy Prompt</button>
          <button class="copy-btn" id="copyAllBtn" onclick="copyAll()">Copy All</button>
        </div>
      </div>
      <div class="md" id="resultContent">${markdownToHTML(fullResult)}</div>
    </div>`;
  $("historyPanel").classList.remove("open");
}

function clearHistory() {
  history = [];
  try { localStorage.removeItem("pf_history"); } catch(e) {}
  renderHistory();
}

// â”€â”€â”€ Markdown â†’ HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function markdownToHTML(text) {
  const lines = text.split("\n");
  const out = [];
  let i = 0;
  while (i < lines.length) {
    const line = lines[i];
    if (line.startsWith("### ")) { out.push("<h3>" + esc(line.slice(4)) + "</h3>"); }
    else if (line.startsWith("## ")) { out.push("<h2>" + esc(line.slice(3)) + "</h2>"); }
    else if (line.startsWith("- ")) {
      out.push("<ul>");
      while (i < lines.length && lines[i].startsWith("- ")) { out.push("<li>" + inline(lines[i].slice(2)) + "</li>"); i++; }
      out.push("</ul>"); continue;
    } else if (/^\d+\.\s/.test(line)) {
      out.push("<ol>");
      while (i < lines.length && /^\d+\.\s/.test(lines[i])) { out.push("<li>" + inline(lines[i].replace(/^\d+\.\s/, "")) + "</li>"); i++; }
      out.push("</ol>"); continue;
    } else if (line.startsWith("```")) {
      const cl = []; i++;
      while (i < lines.length && !lines[i].startsWith("```")) { cl.push(esc(lines[i])); i++; }
      out.push("<pre><code>" + cl.join("\n") + "</code></pre>"); i++; continue;
    } else if (line === "---") { out.push("<hr/>"); }
    else if (line.trim() === "") { out.push('<div class="spacer"></div>'); }
    else { out.push("<p>" + inline(line) + "</p>"); }
    i++;
  }
  return out.join("\n");
}

function esc(s) { return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function inline(s) {
  s = esc(s);
  s = s.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
  s = s.replace(/`(.+?)`/g, "<code>$1</code>");
  return s;
}
</script>
</body>
</html>

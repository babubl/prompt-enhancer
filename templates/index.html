<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PromptOS â€” Prompt Enhancer (V2.1)</title>
  <meta name="description" content="Enhance plain-English questions into expert-level AI prompts. Free and Pro modes. Privacy-first."/>
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
  <main class="container">
    <header class="header">
      <h1>ðŸ§  PromptOS â€” Prompt Enhancer</h1>
      <p class="sub">Turn plain English into powerful AI prompts. Now with <b>Auto Mode</b> detection for health, tech, and more.</p>
      <div class="note" id="privacyBanner">
        <strong>Privacy:</strong> We do not store or log your prompts. Free mode runs locally/deterministically. 
        Pro mode connects via secure, stateless API â€” no data retention.
      </div>
    </header>

    <section class="bar">
      <div class="left">
        <label class="field">
          <span>Mode</span>
          <select id="mode">
            <option value="auto" selected>Auto (Recommended)</option>
            <option value="analytical">Analytical (General)</option>
            <option value="technical">Technical (Engineering)</option>
            <option value="creative">Creative (Writing)</option>
            <option value="health">Health & Nutrition</option>
          </select>
        </label>
        <label class="field">
          <span>Tone</span>
          <select id="tone">
            <option value="concise">Concise</option>
            <option value="formal">Formal</option>
            <option value="friendly">Friendly</option>
            <option value="persuasive">Persuasive</option>
            <option value="neutral">Neutral</option>
          </select>
        </label>
        <label class="field">
          <span>Tier</span>
          <select id="tier">
            <option value="free">Free (Local)</option>
            <option value="pro">Pro (Cloud)</option>
          </select>
        </label>
      </div>
      <div class="right">
        <button id="tip" class="ghost">â˜• Tip</button>
        <button id="privacy" class="ghost">ðŸ”’ Privacy</button>
      </div>
    </section>

    <div id="detectedHint" class="muted" style="margin-bottom:10px; font-size:13px;"></div>

    <aside class="ad-slot" id="ad-slot">
      <span>Ad space â€” coming soon. Help us keep PromptOS free!</span>
    </aside>

    <section class="editor">
      <textarea id="input" placeholder="Type any question, e.g., 'Is coriander good for gut health? Or explain Docker in simple terms.'"></textarea>
      <div class="row">
        <button id="enhance">Enhance</button>
        <button id="clear" class="ghost">Clear</button>
        <button id="historyBtn" class="ghost">History</button>
      </div>
    </section>

    <section id="results" class="results hidden">
      <h2>Enhanced Prompt</h2>
      <pre id="enhanced"></pre>

      <h3>Improvements Added</h3>
      <ul id="improvements"></ul>

      <div class="row">
        <button id="copyEnhanced">Copy</button>
        <button id="downloadJSON" class="ghost">Download JSON</button>
      </div>
      <div id="modelUsed" class="muted"></div>
    </section>

    <section id="historyPanel" class="history hidden">
      <div class="row between">
        <h3>Prompt History (local only)</h3>
        <button id="clearHistory" class="ghost danger">Clear History</button>
      </div>
      <ul id="historyList"></ul>
    </section>

    <footer class="footer">
      <small>
        100% stateless. Free mode is local/deterministic. Pro mode uses external APIs without storage. 
        <a href="#" id="privacyLink">Learn more</a>.
      </small>
    </footer>
  </main>

  <!-- Privacy Modal -->
  <dialog id="privacyModal">
    <h3>Privacy & Trust</h3>
    <p>
      PromptOS does not store or retain your prompts. 
      The <b>Free mode</b> runs locally and deterministically. 
      The <b>Pro mode</b> uses secure third-party LLMs through a stateless proxy, with no data saved.
    </p>
    <ul>
      <li>No cookies or trackers.</li>
      <li>No server-side logging.</li>
      <li>Source code open for review.</li>
    </ul>
    <button id="closePrivacy">Close</button>
  </dialog>

  <!-- Tip Modal -->
  <dialog id="tipModal">
    <h3>Support PromptOS â˜•</h3>
    <p>Enjoy using this? Buy us a coffee â€” funds go toward local model development!</p>
    <ul>
      <li>UPI: <code>babu@upi</code></li>
      <li>Payment link: <a href="https://pay.example.com/buy-coffee" target="_blank" rel="noopener">pay.example.com/buy-coffee</a></li>
    </ul>
    <button id="closeTip">Close</button>
  </dialog>

  <script>
    const $ = (id) => document.getElementById(id);

    const HIST_KEY = "promptos.history.v21";
    function loadHistory() { try { return JSON.parse(localStorage.getItem(HIST_KEY)||"[]"); } catch { return []; } }
    function saveHistory(entry) {
      const h = loadHistory(); h.unshift({...entry,ts:Date.now()});
      localStorage.setItem(HIST_KEY, JSON.stringify(h.slice(0,200)));
    }
    function renderHistory(){
      const list = $("historyList"); list.innerHTML = "";
      const hist = loadHistory();
      if(!hist.length){ const li=document.createElement("li"); li.textContent="No history yet."; list.appendChild(li); return; }
      for(const item of hist){
        const li=document.createElement("li");
        const when = new Date(item.ts).toLocaleString();
        li.innerHTML = `
          <div><strong>Input:</strong> ${escapeHtml(item.input).slice(0,240)}</div>
          <div><strong>Mode:</strong> ${item.mode} &nbsp; <strong>Tone:</strong> ${item.tone} &nbsp; <strong>Tier:</strong> ${item.tier}</div>
          <div class="row">
            <button data-action="restore">Restore</button>
            <button data-action="copy">Copy Result</button>
            <span class="muted" style="margin-left:auto">${when}</span>
          </div>
          <pre>${escapeHtml(item.enhanced).slice(0,1000)}${item.enhanced.length>1000?"â€¦":""}</pre>
        `;
        li.querySelector('[data-action="restore"]').onclick = () => {
          $("input").value=item.input; $("mode").value=item.mode; $("tone").value=item.tone; $("tier").value=item.tier;
          window.scrollTo({top:0,behavior:"smooth"});
        };
        li.querySelector('[data-action="copy"]').onclick = async ()=>{
          await navigator.clipboard.writeText(item.enhanced); alert("Copied enhanced prompt from history.");
        };
        list.appendChild(li);
      }
    }
    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c])) }

    $("historyBtn").onclick = ()=>{ const p=$("historyPanel"); p.classList.toggle("hidden"); if(!p.classList.contains("hidden")) renderHistory(); }
    $("clearHistory").onclick = ()=>{ localStorage.removeItem(HIST_KEY); renderHistory(); }

    $("privacy").onclick = ()=> $("privacyModal").showModal();
    $("privacyLink").onclick = (e)=>{ e.preventDefault(); $("privacyModal").showModal(); }
    $("closePrivacy").onclick = ()=> $("privacyModal").close();
    $("tip").onclick = ()=> $("tipModal").showModal();
    $("closeTip").onclick = ()=> $("tipModal").close();

    $("clear").onclick = ()=>{
      $("input").value=""; $("results").classList.add("hidden");
      $("enhanced").textContent=""; $("improvements").innerHTML=""; $("modelUsed").textContent="";
      $("detectedHint").textContent="";
    };

    $("copyEnhanced").onclick = async ()=>{
      const t = $("enhanced").textContent||""; await navigator.clipboard.writeText(t);
      alert("Enhanced prompt copied!");
    };

    $("downloadJSON").onclick = ()=>{
      const payload = {
        enhanced: $("enhanced").textContent || "",
        improvements: Array.from($("improvements").querySelectorAll("li")).map(li=>li.textContent),
        model_used: $("modelUsed").textContent,
        generated_at: new Date().toISOString()
      };
      const url = URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:"application/json"}));
      const a=document.createElement("a"); a.href=url; a.download="promptos-enhancement.json";
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    };

    $("enhance").onclick = async ()=>{
      const input = $("input").value.trim();
      const mode = $("mode").value;
      const tone = $("tone").value;
      const tier = $("tier").value;

      if(!input){ alert("Please enter a question first."); return; }

      $("enhance").disabled=true; $("enhance").innerText="Enhancingâ€¦";
      $("detectedHint").textContent="";

      try{
        const res = await fetch("/enhance", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ input, mode, tone, tier })
        });
        const data = await res.json();
        if(!res.ok){ throw new Error(data?.error || "Something went wrong"); }

        $("results").classList.remove("hidden");
        $("enhanced").textContent = data.enhanced || "(no result)";
        $("modelUsed").textContent = `Model used: ${data.model_used || "unknown"}${data.note ? " â€” "+data.note : ""}`;
        if(data.improvements){
          $("improvements").innerHTML = "";
          data.improvements.forEach(it=>{
            const li=document.createElement("li"); li.textContent=it; $("improvements").appendChild(li);
          });
        }
        // Show hint for inferred domain (from improvements)
        const modeDetected = (data.improvements || []).find(i => i.toLowerCase().includes("mode preset applied"));
        if(modeDetected){ $("detectedHint").textContent = "ðŸ§© " + modeDetected; }

        saveHistory({ input, mode, tone, tier, enhanced: data.enhanced });
      }catch(err){
        alert(err?.message || String(err));
      }finally{
        $("enhance").disabled=false; $("enhance").innerText="Enhance";
      }
    };
  </script>
</body>
</html>
